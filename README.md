# ProHap_PeptideAnnotator
Pipeline to annotate peptide identifications when using protein databases made by of ProHap / ProVar

### Input format and usage

The pipeline requires Snakemake and Conda installed. You can install these following [this guide](https://snakemake.readthedocs.io/en/stable/getting_started/installation.html), _Installation via Conda/Mamba_. 

Examples of input files and configuration can be found along with the annotation pipeline. Follow the steps below to annotate a list of PSMs:

1. Provide your PSMs or peptides in a tab-separated file having the following four columns (additional columns do not matter):
    - `ID`: Unique identifier for the PSM / peptide
    - `Sequence`: Amino acid sequence of the peptide
    - `Proteins`: List of protein accessions matching the concatenated FASTA file prom ProHap (e.g., `prot_123ab`), separated by semicolon
    - `Positions`: Positions of the first amino acid within the proteins above \(indexed from 0\), separated by semicolon
3. Create a new configuration file based on the example in _[config_example.yaml](https://github.com/ProGenNo/ProHap/blob/main/peptide_annotation/config_example.yaml)_.
4. Provide the path to the configuration file on line 2 of _Snakefile_.
5. Activate the Conda environment to run Snakemake: `conda activate snakemake`
6. Test Snakemake with a dry-run: `snakemake -c1 -n -q`
7. Run the Snakemake pipeline to perform the annotation, specifying the number of available CPU cores in the `--cores` parameter. E.g., when using 30 cores, run `snakemake --cores 30 -p --use-conda`

### Annotation output

The peptide annotation pipeline produces a tab-separated file containing the following columns:

- `ID`: Identifier matching the input file
- `sequence`: Amino acid sequence of the peptide
- `pep_type1`: Peptide classification based on the influence of genetic variation. The possible values are:
    - _contaminant_: peptide matches a contaminant sequence and should be removed from further analysis
    - _canonical_: peptide matches a canonical sequence in Ensembl, without the influence of any genetic variation
    - _single-variant_: peptide contains the product of the alternative allele for one genetic variant
    - _multi-variant_: peptide contains the product of the alternative allele for a set of two or more genetic variants
    - _frameshift_: peptide contains the consequence of the alternative allele of a frameshift variant, the frameshift may also be located upstream of the peptide
    - _variant-no-ref_: Peptide contains the product of the alternative allele for at least one genetic variant. However, the corresponding canonical sequence has not been found in the Ensembl canonical proteome. The peptide should be checked manually.
    - _canonical-no-ref_: Peptide does not cover a product of an alternative allele. However, the sequence has not been found in the Ensembl canonical proteome. The peptide should be checked manually.
- `pep_type2`: Peptide classification based on its ability to distinguish between protein sequences. The possible values are:
    - _contaminant_: peptide matches a contaminant sequence and should be removed from further analysis
    - _proteoform-specific_: maps uniquely to a single form of a protein (i.e., single splice variant and haplotype)
    - _protein-specific_: maps to multiple sequences, which are all products of the same gene
    - _multi-gene_: maps to the products of different genes
- `covered_changes_peptide`: location of matching amino acid changes within the peptide, delimited by a semicolon for multi-variant peptides
- `covered_changes_protein`: covered amino acid changes located within the different matching protein sequences, delimited by "|". E.g., the value `ENST1:123:P>123:R;129:R>129:L|ENST2:223:P>223:R;229:R>229:L` means that there are two amino acid substitutions identified in the _ENST1_ transcript, or two substitutions in the _ENST2_ transcript.
- `covered_alleles_dna`: alleles of genetic variants covered by this peptide. Reference alleles are denoted as _chromosome:position:REF_, alternative alleles denoted as _chromosome:position:REF>ALT_. In case of a multi-gene peptide, the alleles covered in the respective matching genes will be delimited by "|". E.g., the value `1:123456:C>A;1:123798:G|12:987321:T>G` would mean that in the first matching gene, one alternative and one reference allele have been identified, and in the second matching gene, one alternative allele has been identified. The IDs of the respective genes can be found in the _matching_genes_ column.
- `matching_proteins`: identifiers of the proteins matching this peptide. Canonical proteins are identified by the Ensembl ID of the corresponding transcript (ENSTxxx), contaminants by their UniProt name, and sequences generated by ProHap / ProVar by the identifiers of the respective haplotype or variant sequences.
- `positions_in_proteins`: positions of the peptide within these protein sequences
- `matching_transcripts`: identifiers of the matching transcripts in Ensembl (ENSTxxx)
- `matching_genes`: identifiers of the matching genes in Ensembl (ENSGxxx)
- `preceding_indel_shift`: only relevant for haplotype sequences: the cumulative length of any possible upstream in-frame insertions or deletions. Useful to align peptides with the reference protein
- `reading_frames`: only relevant if three-frame translation in ProHap / ProVar is applied (disabled by default): reading frames used for the translations of the respective protein sequences
